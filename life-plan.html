<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>北海道・札幌市教員のための積立＆退職金シミュレーター</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Prop-Types (Rechartsの依存ライブラリ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    
    <!-- Recharts (Stable Version via CDNJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* 数値入力のスピンボタン非表示 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        // 安全にライブラリを取得する即時関数
        const getRecharts = () => {
            if (window.Recharts) return window.Recharts;
            if (window.Recharts && window.Recharts.default) return window.Recharts.default;
            return null;
        };

        const RechartsObj = getRecharts();

        // ライブラリ読み込みエラー時のフォールバック表示
        if (!RechartsObj) {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-slate-100">
                    <div class="bg-white p-8 rounded-xl shadow-lg max-w-md text-center">
                        <div class="text-red-500 text-5xl mb-4">⚠️</div>
                        <h2 class="text-xl font-bold text-slate-800 mb-2">グラフライブラリの読み込みに失敗しました</h2>
                        <p class="text-slate-600 mb-4">インターネット接続を確認するか、ページを再読み込みしてください。</p>
                        <button onclick="window.location.reload()" class="bg-sky-600 text-white px-4 py-2 rounded hover:bg-sky-700 transition">再読み込み</button>
                    </div>
                </div>
            `;
            throw new Error("Recharts library failed to load.");
        }

        const { useState, useEffect, useMemo } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area, ReferenceLine, ComposedChart, Bar } = RechartsObj;

        // --- アイコンコンポーネント ---
        const School = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 22v-4a2 2 0 1 0-4 0v4"/><path d="m18 10 4 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8l4-2"/><path d="M18 5v17"/><path d="m4 6 8-4 8 4"/><path d="M6 5v17"/><circle cx="12" cy="9" r="2"/></svg>
        );
        const Calculator = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
        );
        const TrendingUp = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
        );
        const Info = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
        );
        const Wallet = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"/><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"/></svg>
        );
        const PiggyBank = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2h0V5z"/><path d="M2 9v1c0 1.1.9 2 2 2h1"/><path d="M16 11h0"/></svg>
        );
        const Download = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
        );

        // --- 定数・モデルデータ ---

        // 北海道・札幌市教員 退職手当支給率モデル (令和5年度基準参考)
        const RETIREMENT_RATE_MODEL = {
            self: [
                0, 0.6, 1.2, 1.8, 2.4, 3.0, 3.6, 4.2, 4.8, 5.4, 6.0,  // 0-10年
                7.0, 8.0, 9.0, 10.0, 11.0, // 11-15
                12.2, 13.5, 14.7, 16.0, 17.2, // 16-20
                19.6, 21.0, 22.4, 23.8, 25.2, // 21-25
                26.6, 28.0, 29.4, 30.8, 34.7, // 26-30
                36.0, 37.5, 39.0, 40.8, 40.8, // 31-35
                40.8, 40.8, 40.8, 40.8, 40.8, 40.8, 40.8 // 36+
            ],
            company: [
                0, 0.6, 1.2, 1.8, 2.4, 3.0, 3.6, 4.2, 4.8, 5.4, 6.0, // 0-10
                7.4, 8.8, 10.2, 11.6, 13.0, // 11-15
                15.0, 17.0, 19.0, 21.0, 23.0, // 16-20
                25.5, 27.0, 28.5, 30.0, 31.5, // 21-25
                33.2, 34.9, 36.6, 38.3, 40.0, // 26-30
                41.5, 43.0, 44.5, 46.0, 47.709, // 31-35
                47.709, 47.709, 47.709, 47.709, 47.709, 47.709, 47.709 // 36+
            ]
        };

        // 北海道公立学校教員 推定給料月額モデル
        const getEstimatedSalary = (age) => {
            if (age < 22) return 0;
            if (age < 25) return 21.5 + (age - 22) * 2.0; 
            if (age < 30) return 27.5 + (age - 25) * 0.3; 
            if (age < 35) return 29.0 + (age - 30) * 1.0; 
            if (age < 40) return 34.0 + (age - 35) * 0.4;
            if (age < 45) return 36.0 + (age - 40) * 0.5;
            if (age < 50) return 38.5 + (age - 45) * 0.2;
            if (age < 55) return 39.5 + (age - 50) * 0.2;
            if (age <= 60) return 40.5 + (age - 55) * 0.1; 
            return 41.0; 
        };

        // --- Main Component ---
        const App = () => {
            // State
            const [currentSavings, setCurrentSavings] = useState(100); // 現在の預貯金
            const [initialInvestment, setInitialInvestment] = useState(0); // 現在の運用資産 (時価)
            const [monthlyInvestment, setMonthlyInvestment] = useState(3);
            const [bonusInvestment, setBonusInvestment] = useState(0);
            const [interestRate, setInterestRate] = useState(5);
            
            const [startAge, setStartAge] = useState(22);
            const [currentAge, setCurrentAge] = useState(30);
            const [retireAge, setRetireAge] = useState(60);
            const [salaryMode, setSalaryMode] = useState('auto');
            const [manualMonthlySalary, setManualMonthlySalary] = useState(35);
            const [retirementReason, setRetirementReason] = useState('company');

            // 取り崩し・退職金設定
            const [retirementMoneyDest, setRetirementMoneyDest] = useState('invest'); // 'invest' | 'savings'
            const [withdrawalStartAge, setWithdrawalStartAge] = useState(60);
            const [withdrawalMode, setWithdrawalMode] = useState('rate'); // 'rate' | 'fixed'
            const [withdrawalRate, setWithdrawalRate] = useState(4.0); // %
            const [withdrawalMonthlyAmount, setWithdrawalMonthlyAmount] = useState(10); // 万円
            const [simulationEndAge, setSimulationEndAge] = useState(100); // シミュレーション終了年齢

            const [activeTab, setActiveTab] = useState('simulation');

            // 退職年齢が変わったら取り崩し開始年齢も連動させる
            useEffect(() => {
                if (withdrawalStartAge < retireAge) {
                    setWithdrawalStartAge(retireAge);
                }
            }, [retireAge]);

            // Calculations
            const currentSalary = useMemo(() => {
                return salaryMode === 'auto' ? getEstimatedSalary(currentAge) : (Number(manualMonthlySalary) || 0);
            }, [salaryMode, currentAge, manualMonthlySalary]);

            const estimatedRetireSalary = useMemo(() => {
                if (salaryMode === 'manual') return (Number(manualMonthlySalary) || 0);
                return getEstimatedSalary(retireAge);
            }, [salaryMode, retireAge, manualMonthlySalary]);

            const simulationData = useMemo(() => {
                const data = [];
                const safeSavings = Number(currentSavings) || 0;
                const safeInitial = Number(initialInvestment) || 0;
                const safeMonthly = Number(monthlyInvestment) || 0;
                const safeBonus = Number(bonusInvestment) || 0;
                const safeInterest = Number(interestRate) || 0;
                
                const safeWithdrawalRate = Number(withdrawalRate) || 0;
                const safeWithdrawalAmount = Number(withdrawalMonthlyAmount) || 0;

                let currentInvestAsset = safeInitial * 10000; // 運用資産の現在価値 (時価)
                let totalInvestPrincipal = safeInitial * 10000; // 運用資産の元本 (簿価相当)
                let currentSavingsAsset = safeSavings * 10000; // 預貯金
                
                // 退職金は退職時に計算して運用資産または預貯金に組み込むフラグ
                let retirementMoneyAdded = false;
                
                const endAge = Math.max(simulationEndAge, currentAge + 1);
                const monthlyRate = safeInterest / 100 / 12;

                for (let age = currentAge; age <= endAge; age++) {
                    let yearlyWithdrawal = 0; // 年間の取り崩し額合計

                    // --- 退職金の計算と組み込み ---
                    let retirementMoney = 0;
                    if (age === retireAge && !retirementMoneyAdded) {
                        let workYears = age - startAge;
                        if (workYears < 0) workYears = 0;
                        const rateIndex = Math.min(Math.floor(workYears), 42); 
                        const reason = retirementReason;
                        const rate = RETIREMENT_RATE_MODEL[reason][Math.min(rateIndex, RETIREMENT_RATE_MODEL[reason].length - 1)] || 0;
                        const baseSalary = salaryMode === 'auto' ? getEstimatedSalary(age) : (Number(manualMonthlySalary) || 0);
                        retirementMoney = baseSalary * 10000 * rate;
                        
                        // 退職金の行き先分岐
                        if (retirementMoneyDest === 'invest') {
                            // 投資元本へ
                            currentInvestAsset += retirementMoney;
                            totalInvestPrincipal += retirementMoney;
                        } else {
                            // 預貯金へ
                            currentSavingsAsset += retirementMoney;
                        }
                        retirementMoneyAdded = true;
                    }

                    // --- 1年間の運用 & 積立 & 取り崩し ---
                    for (let month = 1; month <= 12; month++) {
                        // 1. まず運用（月利）- 時価のみ変動 (預貯金は変動なし)
                        currentInvestAsset = currentInvestAsset * (1 + monthlyRate);

                        // 2. 積立（退職前のみ）- 時価と元本両方変動
                        if (age < retireAge) {
                            currentInvestAsset += (safeMonthly * 10000);
                            totalInvestPrincipal += (safeMonthly * 10000);
                            if (month === 6 || month === 12) {
                                currentInvestAsset += (safeBonus * 10000);
                                totalInvestPrincipal += (safeBonus * 10000);
                            }
                        }

                        // 3. 取り崩し（指定年齢以降）
                        if (age >= withdrawalStartAge) {
                            let withdrawAmount = 0;
                            if (withdrawalMode === 'fixed') {
                                withdrawAmount = safeWithdrawalAmount * 10000;
                            } else {
                                // 定率取り崩しは運用資産残高ベースで行うのが一般的（預貯金からは定率では引けないため）
                                // ここでは簡易的に「運用資産残高」に対して率を掛ける
                                withdrawAmount = currentInvestAsset * (safeWithdrawalRate / 100 / 12);
                            }

                            // 取り崩し順序: 運用資産 -> なくなったら預貯金
                            if (currentInvestAsset >= withdrawAmount) {
                                // 運用資産で賄える場合
                                const ratio = currentInvestAsset > 0 ? withdrawAmount / currentInvestAsset : 0;
                                currentInvestAsset -= withdrawAmount;
                                totalInvestPrincipal -= totalInvestPrincipal * ratio;
                            } else {
                                // 運用資産だけでは足りない場合
                                let remain = withdrawAmount - currentInvestAsset;
                                currentInvestAsset = 0;
                                totalInvestPrincipal = 0;
                                
                                // 残りを預貯金から
                                if (currentSavingsAsset >= remain) {
                                    currentSavingsAsset -= remain;
                                } else {
                                    // 預貯金も尽きた
                                    remain -= currentSavingsAsset;
                                    currentSavingsAsset = 0;
                                    withdrawAmount -= remain; // 実際に取り崩せた額だけ記録
                                }
                            }
                            yearlyWithdrawal += withdrawAmount;
                        }
                    }

                    // 運用益の計算
                    let profit = currentInvestAsset - totalInvestPrincipal;
                    
                    let displayPrincipal = totalInvestPrincipal;
                    let displayProfit = profit;

                    if (profit < 0) {
                        displayPrincipal = currentInvestAsset;
                        displayProfit = 0;
                    }

                    // savings: 預貯金
                    const grandTotal = currentSavingsAsset + currentInvestAsset;

                    data.push({
                        age: age,
                        savings: Math.round(currentSavingsAsset / 10000),
                        principal: Math.round(displayPrincipal / 10000),
                        profit: Math.round(displayProfit / 10000),
                        investTotal: Math.round(currentInvestAsset / 10000),
                        retirementMoney: Math.round(retirementMoney / 10000), 
                        grandTotal: Math.round(grandTotal / 10000),
                        yearlyWithdrawal: Math.round(yearlyWithdrawal / 10000),
                        isRetireYear: age === retireAge,
                        isWithdrawalStart: age === withdrawalStartAge,
                    });
                }
                return data;
            }, [currentSavings, initialInvestment, monthlyInvestment, bonusInvestment, interestRate, currentAge, startAge, retireAge, salaryMode, manualMonthlySalary, retirementReason, withdrawalStartAge, withdrawalMode, withdrawalRate, withdrawalMonthlyAmount, simulationEndAge, retirementMoneyDest]);

            // 退職金見込額
            const retirementInfo = useMemo(() => {
                const years = retireAge - startAge;
                const rateIndex = Math.min(Math.max(0, Math.floor(years)), 42);
                const rate = RETIREMENT_RATE_MODEL[retirementReason][Math.min(rateIndex, RETIREMENT_RATE_MODEL[retirementReason].length - 1)] || 0;
                const amount = estimatedRetireSalary * rate;
                return {
                    years,
                    rate,
                    amount: Math.round(amount * 10) / 10,
                };
            }, [retireAge, startAge, retirementReason, estimatedRetireSalary]);

            const formatYen = (val) => {
                return new Intl.NumberFormat('ja-JP').format(val);
            };

            const handleNumberInput = (setter) => (e) => {
                const value = e.target.value;
                setter(value === '' ? '' : Number(value));
            };

            // ラベルの重なり回避用判定 (退職年齢と取崩開始年齢が近い場合)
            const isLabelOverlapping = Math.abs(retireAge - withdrawalStartAge) <= 10;

            // CSV Download Function
            const downloadCSV = () => {
                const headers = ["年齢", "投資元本(万円)", "運用益(万円)", "年間取崩額(万円)", "預貯金(万円)", "総資産合計(万円)", "備考"];
                const csvContent = [
                    headers.join(","),
                    ...simulationData.map(row => {
                        const memo = [];
                        if (row.isRetireYear) memo.push(`退職(退職金+${row.retirementMoney}万円)`);
                        if (row.isWithdrawalStart) memo.push("取崩開始");
                        
                        return [
                            row.age,
                            row.principal,
                            row.profit,
                            row.yearlyWithdrawal,
                            row.savings,
                            row.grandTotal,
                            memo.join(" / ")
                        ].join(",");
                    })
                ].join("\n");

                // BOMを付加して文字化け防止
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                const filename = `teacher_asset_simulation_${new Date().toISOString().slice(0,10)}.csv`;
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            // JSX Render
            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-10">
                    {/* Header */}
                    <header className="bg-sky-700 text-white p-4 shadow-md sticky top-0 z-10">
                        <div className="container mx-auto max-w-6xl flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <School className="h-6 w-6" />
                                <h1 className="text-xl font-bold">北海道・札幌市教員のための積立＆退職金シミュレーター</h1>
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto max-w-6xl p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* Settings */}
                        <div className="lg:col-span-4 space-y-6">
                            {/* 1. Profile */}
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                                <div className="flex items-center gap-2 mb-4 text-sky-700 border-b pb-2">
                                    <Calculator className="h-5 w-5" />
                                    <h2 className="font-bold">1. 教員プロフィール設定</h2>
                                </div>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-medium text-slate-500 mb-1">採用年齢</label>
                                            <div className="relative">
                                                <input type="number" value={startAge} onChange={handleNumberInput(setStartAge)} className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-sky-500 focus:outline-none"/>
                                                <span className="absolute right-3 top-2 text-sm text-slate-400">歳</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-slate-500 mb-1">現在年齢</label>
                                            <div className="relative">
                                                <input type="number" value={currentAge} onChange={handleNumberInput(setCurrentAge)} className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-sky-500 focus:outline-none"/>
                                                <span className="absolute right-3 top-2 text-sm text-slate-400">歳</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">退職予定年齢 (勤続 {retireAge - startAge}年)</label>
                                        <div className="relative">
                                            <input type="range" min={Math.max(Number(currentAge) || 30, 30)} max={70} value={retireAge} onChange={(e) => setRetireAge(Number(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sky-600 mb-2"/>
                                            <div className="flex justify-between items-center">
                                                <span className="text-xs text-slate-400">現在</span>
                                                <span className="font-bold text-sky-700 text-lg">{retireAge}歳</span>
                                                <span className="text-xs text-slate-400">70歳</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="pt-2 border-t border-dashed border-slate-200">
                                        <label className="block text-xs font-medium text-slate-500 mb-2">退職事由 & 給与計算ベース</label>
                                        <div className="flex gap-2 mb-3">
                                            <button onClick={() => setRetirementReason('company')} className={`flex-1 py-1.5 text-xs rounded border ${retirementReason === 'company' ? 'bg-sky-50 border-sky-500 text-sky-700 font-bold' : 'bg-white border-slate-200 text-slate-600'}`}>定年・勧奨</button>
                                            <button onClick={() => setRetirementReason('self')} className={`flex-1 py-1.5 text-xs rounded border ${retirementReason === 'self' ? 'bg-orange-50 border-orange-500 text-orange-700 font-bold' : 'bg-white border-slate-200 text-slate-600'}`}>自己都合</button>
                                        </div>
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-xs text-slate-500">基本給月額の計算 (諸手当含まず)</span>
                                            <div className="flex text-xs bg-slate-100 p-0.5 rounded">
                                                <button onClick={() => setSalaryMode('auto')} className={`px-2 py-0.5 rounded ${salaryMode === 'auto' ? 'bg-white shadow text-slate-800' : 'text-slate-400'}`}>自動推計</button>
                                                <button onClick={() => setSalaryMode('manual')} className={`px-2 py-0.5 rounded ${salaryMode === 'manual' ? 'bg-white shadow text-slate-800' : 'text-slate-400'}`}>手入力</button>
                                            </div>
                                        </div>
                                        {salaryMode === 'auto' ? (
                                            <div className="text-xs text-slate-500 bg-slate-50 p-2 rounded">
                                                北海道公立学校教員モデルより算出: <br/>
                                                現在 <span className="font-bold text-slate-700">{currentSalary.toFixed(1)}万円</span> → 退職時 <span className="font-bold text-slate-700">{estimatedRetireSalary.toFixed(1)}万円</span>
                                            </div>
                                        ) : (
                                            <div className="relative">
                                                <input type="number" value={manualMonthlySalary} onChange={handleNumberInput(setManualMonthlySalary)} className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-sky-500 focus:outline-none"/>
                                                <span className="absolute right-8 top-2 text-sm text-slate-500">万円</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {/* 2. Investment */}
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                                <div className="flex items-center gap-2 mb-4 text-emerald-600 border-b pb-2">
                                    <TrendingUp className="h-5 w-5" />
                                    <h2 className="font-bold">2. 積立投資設定 (NISA/iDeCo)</h2>
                                </div>
                                <div className="space-y-4">
                                    <div className="bg-emerald-50 p-3 rounded-lg border border-emerald-100 mb-4">
                                        <h3 className="text-xs font-bold text-emerald-800 flex items-center gap-1 mb-3">
                                            <Wallet className="w-4 h-4" /> 現在の資産状況
                                        </h3>
                                        <div className="grid grid-cols-1 gap-4">
                                            <div>
                                                <label className="block text-xs font-medium text-emerald-700 mb-1">現在の預貯金 (運用しない)</label>
                                                <div className="relative">
                                                    <input type="number" value={currentSavings} onChange={handleNumberInput(setCurrentSavings)} className="w-full p-2 border border-emerald-300 rounded focus:ring-2 focus:ring-emerald-500 focus:outline-none bg-white"/>
                                                    <span className="absolute right-3 top-2 text-sm text-slate-400">万円</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-emerald-700 mb-1">現在の運用資産残高 (時価・評価額)</label>
                                                <div className="relative">
                                                    <input type="number" value={initialInvestment} onChange={handleNumberInput(setInitialInvestment)} className="w-full p-2 border border-emerald-300 rounded focus:ring-2 focus:ring-emerald-500 focus:outline-none bg-white"/>
                                                    <span className="absolute right-3 top-2 text-sm text-slate-400">万円</span>
                                                </div>
                                                <p className="text-[10px] text-emerald-600 mt-1">※含み益を含めた現在の金額を入力してください</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">毎月の積立額</label>
                                        <div className="relative">
                                            <input type="number" value={monthlyInvestment} onChange={handleNumberInput(setMonthlyInvestment)} className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-emerald-500 focus:outline-none font-bold text-lg"/>
                                            <span className="absolute right-3 top-2.5 text-slate-400">万円</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">ボーナス時の増額 (年2回)</label>
                                        <div className="relative">
                                            <input type="number" value={bonusInvestment} onChange={handleNumberInput(setBonusInvestment)} className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-emerald-500 focus:outline-none"/>
                                            <span className="absolute right-3 top-2 text-slate-400">万円</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">想定年利</label>
                                        <div className="relative">
                                            <input type="number" step="0.1" value={interestRate} onChange={handleNumberInput(setInterestRate)} className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-emerald-500 focus:outline-none"/>
                                            <span className="absolute right-3 top-2 text-sm text-slate-400">%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* 3. Withdrawal Strategy */}
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                                <div className="flex items-center gap-2 mb-4 text-orange-600 border-b pb-2">
                                    <PiggyBank className="h-5 w-5" />
                                    <h2 className="font-bold">3. 取り崩し設定 (出口戦略)</h2>
                                </div>
                                <div className="space-y-4">
                                    {/* 退職金の受取設定 */}
                                    <div className="mb-2">
                                        <label className="block text-xs font-medium text-slate-500 mb-2">退職金の受取後の運用</label>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => setRetirementMoneyDest('invest')}
                                                className={`flex-1 py-2 text-xs rounded border ${retirementMoneyDest === 'invest' ? 'bg-sky-600 border-sky-700 text-white font-bold shadow' : 'bg-white border-slate-200 text-slate-600'}`}
                                            >
                                                全額 投資へ
                                                <span className="block text-[10px] font-normal opacity-80">運用して取り崩す</span>
                                            </button>
                                            <button
                                                onClick={() => setRetirementMoneyDest('savings')}
                                                className={`flex-1 py-2 text-xs rounded border ${retirementMoneyDest === 'savings' ? 'bg-emerald-600 border-emerald-700 text-white font-bold shadow' : 'bg-white border-slate-200 text-slate-600'}`}
                                            >
                                                全額 預貯金へ
                                                <span className="block text-[10px] font-normal opacity-80">元本保証で安心</span>
                                            </button>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">取り崩し開始年齢</label>
                                        <div className="relative">
                                            <input
                                                type="range"
                                                min={retireAge}
                                                max={80}
                                                value={withdrawalStartAge}
                                                onChange={(e) => setWithdrawalStartAge(Number(e.target.value))}
                                                className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-orange-500 mb-2"
                                            />
                                            <div className="flex justify-between items-center">
                                                <span className="text-xs text-slate-400">退職時 ({retireAge}歳)</span>
                                                <span className="font-bold text-orange-600 text-lg">{withdrawalStartAge}歳</span>
                                                <span className="text-xs text-slate-400">80歳</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-orange-50 p-3 rounded-lg border border-orange-100">
                                        <div className="flex gap-2 mb-3">
                                            <button
                                                onClick={() => setWithdrawalMode('rate')}
                                                className={`flex-1 py-1.5 text-xs rounded border ${withdrawalMode === 'rate' ? 'bg-orange-500 border-orange-600 text-white font-bold shadow' : 'bg-white border-slate-200 text-slate-600'}`}
                                            >
                                                定率 (4%ルール等)
                                            </button>
                                            <button
                                                onClick={() => setWithdrawalMode('fixed')}
                                                className={`flex-1 py-1.5 text-xs rounded border ${withdrawalMode === 'fixed' ? 'bg-orange-500 border-orange-600 text-white font-bold shadow' : 'bg-white border-slate-200 text-slate-600'}`}
                                            >
                                                定額 (万円/月)
                                            </button>
                                        </div>

                                        {withdrawalMode === 'rate' ? (
                                            <div>
                                                <label className="block text-xs font-medium text-orange-800 mb-1">毎年 資産の何%を取り崩す？</label>
                                                <div className="relative">
                                                    <input type="number" step="0.1" value={withdrawalRate} onChange={handleNumberInput(setWithdrawalRate)} className="w-full p-2 border border-orange-300 rounded focus:ring-2 focus:ring-orange-500 focus:outline-none font-bold text-lg text-orange-700 bg-white"/>
                                                    <span className="absolute right-3 top-2.5 text-slate-500">%</span>
                                                </div>
                                                <p className="text-[10px] text-orange-700 mt-1">※4%ルールでは「4%」に設定。資産残高に応じて受取額が変動します。</p>
                                            </div>
                                        ) : (
                                            <div>
                                                <label className="block text-xs font-medium text-orange-800 mb-1">毎月 いくら取り崩す？</label>
                                                <div className="relative">
                                                    <input type="number" value={withdrawalMonthlyAmount} onChange={handleNumberInput(setWithdrawalMonthlyAmount)} className="w-full p-2 border border-orange-300 rounded focus:ring-2 focus:ring-orange-500 focus:outline-none font-bold text-lg text-orange-700 bg-white"/>
                                                    <span className="absolute right-3 top-2.5 text-slate-500">万円</span>
                                                </div>
                                                <p className="text-[10px] text-orange-700 mt-1">※定額で受け取ります。運用益が追いつかないと資産が早く枯渇します。</p>
                                            </div>
                                        )}
                                    </div>

                                    {/* シミュレーション終了年齢スライダー */}
                                    <div className="pt-2 border-t border-dashed border-slate-200">
                                        <label className="block text-xs font-medium text-slate-500 mb-1">グラフ表示期間 (寿命設定)</label>
                                        <div className="relative">
                                            <input
                                                type="range"
                                                min={80}
                                                max={120}
                                                value={simulationEndAge}
                                                onChange={(e) => setSimulationEndAge(Number(e.target.value))}
                                                className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-500 mb-2"
                                            />
                                            <div className="flex justify-between items-center">
                                                <span className="text-xs text-slate-400">80歳</span>
                                                <span className="font-bold text-slate-600 text-lg">{simulationEndAge}歳</span>
                                                <span className="text-xs text-slate-400">120歳</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Results */}
                        <div className="lg:col-span-8 space-y-6">
                            <div className="bg-gradient-to-r from-sky-600 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                                <h3 className="text-sm font-medium opacity-90 mb-4 flex items-center gap-2">
                                    <School className="w-4 h-4" />
                                    {withdrawalStartAge}歳時点の資産状況
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-center md:text-left">
                                    <div>
                                        <div className="text-xs opacity-75 mb-1">運用資産残高 (退職金{retirementMoneyDest === 'invest' ? '込' : '別'})</div>
                                        <div className="text-2xl md:text-3xl font-bold">
                                            {formatYen(simulationData.find(d => d.age === withdrawalStartAge)?.investTotal || 0)}
                                            <span className="text-sm font-normal ml-1">万円</span>
                                        </div>
                                    </div>
                                    <div className="relative">
                                        <div className="absolute -left-3 top-2 bottom-2 w-px bg-white/20 hidden md:block"></div>
                                        <div className="text-xs opacity-75 mb-1">初年度の年間受取額(取崩額)</div>
                                        <div className="text-2xl md:text-3xl font-bold text-yellow-300">
                                            {formatYen(simulationData.find(d => d.age === withdrawalStartAge)?.yearlyWithdrawal || 0)}
                                            <span className="text-sm font-normal ml-1 text-white">万円</span>
                                        </div>
                                        <div className="text-xs opacity-75">月額換算: 約{formatYen(Math.round((simulationData.find(d => d.age === withdrawalStartAge)?.yearlyWithdrawal || 0)/12))}万円</div>
                                    </div>
                                    <div className="relative">
                                        <div className="absolute -left-3 top-2 bottom-2 w-px bg-white/20 hidden md:block"></div>
                                        <div className="text-xs opacity-75 mb-1">{simulationEndAge}歳時点の残資産</div>
                                        <div className="text-3xl md:text-4xl font-bold">
                                            {formatYen((simulationData.find(d => d.age === simulationEndAge)?.grandTotal || 0))}
                                            <span className="text-sm font-normal ml-1">万円</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-6">
                                <div className="flex items-center justify-between mb-6">
                                    <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                        <TrendingUp className="h-5 w-5 text-sky-600" />
                                        資産推移グラフ ({simulationEndAge}歳まで)
                                    </h3>
                                    <div className="flex gap-2">
                                        <button onClick={() => setActiveTab('simulation')} className={`text-xs px-3 py-1 rounded-full ${activeTab === 'simulation' ? 'bg-sky-100 text-sky-700 font-bold' : 'text-slate-500 hover:bg-slate-100'}`}>グラフ</button>
                                        <button onClick={() => setActiveTab('table')} className={`text-xs px-3 py-1 rounded-full ${activeTab === 'table' ? 'bg-sky-100 text-sky-700 font-bold' : 'text-slate-500 hover:bg-slate-100'}`}>詳細テーブル</button>
                                        
                                        {/* CSV Download Button */}
                                        {activeTab === 'table' && (
                                            <button 
                                                onClick={downloadCSV}
                                                className="text-xs px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 font-bold flex items-center gap-1 hover:bg-emerald-200 transition-colors"
                                                title="CSV形式でダウンロード"
                                            >
                                                <Download className="w-3 h-3" /> 保存
                                            </button>
                                        )}
                                    </div>
                                </div>

                                {activeTab === 'simulation' ? (
                                    <div className="h-[350px] w-full">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <ComposedChart data={simulationData} margin={{ top: 10, right: 30, left: 0, bottom: 30 }}>
                                                <defs>
                                                    <linearGradient id="colorProfit" x1="0" y1="0" x2="0" y2="1">
                                                        <stop offset="5%" stopColor="#82ca9d" stopOpacity={0.8}/>
                                                        <stop offset="95%" stopColor="#82ca9d" stopOpacity={0}/>
                                                    </linearGradient>
                                                    <linearGradient id="colorPrincipal" x1="0" y1="0" x2="0" y2="1">
                                                        <stop offset="5%" stopColor="#8884d8" stopOpacity={0.8}/>
                                                        <stop offset="95%" stopColor="#8884d8" stopOpacity={0}/>
                                                    </linearGradient>
                                                    <linearGradient id="colorSavings" x1="0" y1="0" x2="0" y2="1">
                                                        <stop offset="5%" stopColor="#94a3b8" stopOpacity={0.8}/>
                                                        <stop offset="95%" stopColor="#94a3b8" stopOpacity={0}/>
                                                    </linearGradient>
                                                </defs>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                <XAxis dataKey="age" type="number" domain={[currentAge, simulationEndAge]} label={{ value: '年齢', position: 'insideBottomRight', offset: -5 }} />
                                                <YAxis tickFormatter={(val) => `${val}`} label={{ value: '万円', angle: -90, position: 'insideLeft' }} />
                                                <Tooltip formatter={(value, name) => {
                                                    if (name === 'profit') return [`${formatYen(value)}万円`, '運用益'];
                                                    if (name === 'principal') return [`${formatYen(value)}万円`, '投資元本'];
                                                    if (name === 'savings') return [`${formatYen(value)}万円`, '預貯金(運用外)'];
                                                    if (name === 'yearlyWithdrawal') return [`${formatYen(value)}万円`, '年間取崩額'];
                                                    return [`${formatYen(value)}万円`, name];
                                                }} labelFormatter={(label) => `${label}歳時点`} />
                                                <Legend verticalAlign="top" height={36}/>
                                                <Area type="monotone" dataKey="savings" stackId="1" stroke="#94a3b8" fill="url(#colorSavings)" name="預貯金(運用外)" />
                                                <Area type="monotone" dataKey="principal" stackId="1" stroke="#8884d8" fill="url(#colorPrincipal)" name="投資元本" />
                                                <Area type="monotone" dataKey="profit" stackId="1" stroke="#82ca9d" fill="url(#colorProfit)" name="運用益" />
                                                
                                                {retireAge === withdrawalStartAge ? (
                                                    <ReferenceLine x={retireAge} stroke="red" strokeDasharray="3 3" label={{ value: "退職・取崩開始", position: "insideTopLeft", fill: "red", fontSize: 12 }} />
                                                ) : (
                                                    <>
                                                        <ReferenceLine x={retireAge} stroke="red" strokeDasharray="3 3" label={{ value: "退職", position: "insideTopLeft", fill: "red", fontSize: 12 }} />
                                                        <ReferenceLine 
                                                            x={withdrawalStartAge} 
                                                            stroke="orange" 
                                                            strokeDasharray="3 3" 
                                                            label={{ 
                                                                value: "取崩開始", 
                                                                position: "insideTopRight", 
                                                                fill: "orange", 
                                                                fontSize: 12,
                                                                dy: isLabelOverlapping ? 20 : 0 // ラベル被り対策：近い場合は下にずらす
                                                            }} 
                                                        />
                                                    </>
                                                )}
                                            </ComposedChart>
                                        </ResponsiveContainer>
                                        <p className="text-xs text-center text-slate-400 mt-2">※退職時に退職金が「{retirementMoneyDest === 'invest' ? '投資元本' : '預貯金'}」に合算されます。</p>
                                    </div>
                                ) : (
                                    <div className="overflow-x-auto max-h-[350px]">
                                        <table className="w-full text-sm text-left text-slate-600">
                                            <thead className="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0">
                                                <tr>
                                                    <th className="px-4 py-3">年齢</th>
                                                    <th className="px-4 py-3">投資元本</th>
                                                    <th className="px-4 py-3">運用益</th>
                                                    <th className="px-4 py-3">年間取崩額</th>
                                                    <th className="px-4 py-3">預貯金</th>
                                                    <th className="px-4 py-3 font-bold text-sky-700">総資産合計</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {simulationData.map((row) => (
                                                    <tr key={row.age} className={`border-b ${row.age === retireAge ? 'bg-sky-50 font-medium' : ''} ${row.age >= withdrawalStartAge ? 'bg-orange-50/30' : ''}`}>
                                                        <td className="px-4 py-3">
                                                            {row.age}歳
                                                            {row.age === retireAge && <span className="block text-[10px] text-red-500">退職金+{formatYen(row.retirementMoney)}</span>}
                                                        </td>
                                                        <td className="px-4 py-3 text-slate-600">{formatYen(row.principal)}万円</td>
                                                        <td className="px-4 py-3 text-emerald-600">+{formatYen(row.profit)}万円</td>
                                                        <td className="px-4 py-3 text-orange-600">
                                                            {row.yearlyWithdrawal > 0 ? `${formatYen(row.yearlyWithdrawal)}万円` : '-'}
                                                        </td>
                                                        <td className="px-4 py-3 text-slate-500">{formatYen(row.savings)}万円</td>
                                                        <td className="px-4 py-3 font-bold">{formatYen(row.grandTotal)}万円</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                            <div className="bg-slate-100 rounded-lg p-4 text-xs text-slate-500 space-y-2">
                                <h4 className="font-bold text-slate-600 flex items-center gap-1">
                                    <Info className="w-3 h-3" />
                                    計算ロジックについて
                                </h4>
                                <p>・<strong>退職金の運用:</strong> 退職金は受け取りと同時に、選択した「投資元本」または「預貯金」に組み込まれます。</p>
                                <p>・<strong>取り崩し:</strong> 取り崩しはまず運用資産（利益を含む）から行われ、不足した場合に預貯金から充当されます。運用資産取り崩し時は、元本と利益の比率に応じて減少します。</p>
                                <p>・<strong>4%ルール:</strong> 年利4%以上で運用しながら、毎年資産の4%ずつ取り崩せば理論上資産は減らない（あるいは30年以上枯渇しない）とされる経験則です。</p>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
