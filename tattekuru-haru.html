<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«‹ã£ã¦ãã‚‹æ˜¥ - å­¦ç¿’ãƒ“ãƒ¥ãƒ¼ã‚¢</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: èª­ã¿ã‚„ã™ã•ã®ãŸã‚ã«æ˜æœä½“ã¨ã‚´ã‚·ãƒƒã‚¯ä½“ã‚’ãƒ­ãƒ¼ãƒ‰ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;700&family=Zen+Old+Mincho:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Zen Kaku Gothic New"', 'sans-serif'],
                        serif: ['"Zen Old Mincho"', 'serif'],
                    },
                    colors: {
                        theme: {
                            light: '#fdfbf7', // ç´™ã®ã‚ˆã†ãªç™½
                            dark: '#1f2937',  // èª­ã¿ã‚„ã™ã„ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼
                            accent: '#8b5e3c', // æ–‡å­¦çš„ãªèŒ¶è‰²
                            highlight: '#fff3cd', // ãƒãƒ¼ã‚«ãƒ¼è‰²
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            background-color: #fdfbf7;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* èª­æ›¸ç”¨ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆã‚¢ãƒ³ãƒ€ãƒ¼ãƒ©ã‚¤ãƒ³é¢¨ï¼‰ */
        .text-highlight {
            background: linear-gradient(transparent 60%, #ffeeba 60%);
            cursor: pointer;
            transition: background 0.2s;
            padding-bottom: 2px;
            font-weight: 600;
        }
        .text-highlight:hover, .text-highlight.active {
            background: #ffeeba;
            color: #000;
        }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .accordion-content.open {
            opacity: 1;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è£…é£¾ï¼ˆWebkitï¼‰ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
    </style>
</head>
<body class="font-sans antialiased leading-relaxed min-h-screen flex flex-col">

    <!-- 
    ========================================================================
    1. ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼
    ========================================================================
    -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md shadow-sm border-b border-gray-100">
        <div class="max-w-4xl mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-4">
            <!-- ã‚¿ã‚¤ãƒˆãƒ«ã‚¨ãƒªã‚¢ -->
            <div class="text-center md:text-left">
                <h1 id="header-title" class="text-xl font-bold font-serif text-gray-800"></h1>
                <p id="header-author" class="text-xs text-gray-500 tracking-wider"></p>
            </div>

            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
            <nav class="flex overflow-x-auto w-full md:w-auto gap-2 pb-1 md:pb-0 no-scrollbar">
                <button onclick="switchView('overview')" id="nav-overview" class="nav-btn px-4 py-2 text-sm font-bold rounded-full transition-colors whitespace-nowrap bg-gray-100 text-gray-600 hover:bg-theme-accent hover:text-white">
                    å¤§ã¾ã‹ãªå†…å®¹
                </button>
                <button onclick="switchView('characters')" id="nav-characters" class="nav-btn px-4 py-2 text-sm font-bold rounded-full transition-colors whitespace-nowrap bg-gray-100 text-gray-600 hover:bg-theme-accent hover:text-white">
                    ç™»å ´äººç‰©ãƒ»è¦ç´ 
                </button>
                <button onclick="switchView('keywords')" id="nav-keywords" class="nav-btn px-4 py-2 text-sm font-bold rounded-full transition-colors whitespace-nowrap bg-gray-100 text-gray-600 hover:bg-theme-accent hover:text-white">
                    ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
                </button>
                <button onclick="switchView('read')" id="nav-read" class="nav-btn px-4 py-2 text-sm font-bold rounded-full transition-colors whitespace-nowrap bg-theme-accent text-white shadow-md">
                    æœ¬æ–‡ã‚’èª­ã‚€
                </button>
            </nav>
        </div>
    </header>

    <!-- 
    ========================================================================
    ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢
    JavaScriptã§è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™
    ========================================================================
    -->
    <main class="flex-grow max-w-3xl mx-auto w-full px-5 py-8 pb-32">
        
        <!-- ãƒ“ãƒ¥ãƒ¼1: å¤§ã¾ã‹ãªå†…å®¹ (Overview) -->
        <section id="view-overview" class="view-section hidden space-y-6">
            <h2 class="text-2xl font-bold border-l-4 border-theme-accent pl-4 mb-6">ä½œå“æ§‹æˆã¨è¦ç´„</h2>
            <div id="overview-container" class="space-y-4">
                <!-- JSã§ç”Ÿæˆ -->
            </div>
        </section>

        <!-- ãƒ“ãƒ¥ãƒ¼2: ç™»å ´äººç‰©ãƒ»è¦ç´  (Characters) -->
        <section id="view-characters" class="view-section hidden space-y-6">
            <h2 class="text-2xl font-bold border-l-4 border-theme-accent pl-4 mb-6">ç™»å ´äººç‰©ãƒ»è¦ç´ åˆ†æ</h2>
            <div id="characters-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- JSã§ç”Ÿæˆ -->
            </div>
        </section>

        <!-- ãƒ“ãƒ¥ãƒ¼3: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (Keywords) -->
        <section id="view-keywords" class="view-section hidden space-y-6">
            <h2 class="text-2xl font-bold border-l-4 border-theme-accent pl-4 mb-6">é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»è±¡å¾´</h2>
            <div class="bg-yellow-50 p-4 rounded-lg text-sm text-yellow-800 mb-4">
                <i class="mr-1">ğŸ’¡</i> ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨æ–‡è„ˆè§£èª¬ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
            </div>
            <div id="keywords-container" class="space-y-3">
                <!-- JSã§ç”Ÿæˆ -->
            </div>
        </section>

        <!-- ãƒ“ãƒ¥ãƒ¼4: æœ¬æ–‡ã‚’èª­ã‚€ (Read Text) -->
        <section id="view-read" class="view-section">
            <div class="flex justify-between items-end mb-8 border-b pb-4">
                <h2 class="text-3xl font-serif font-bold text-gray-900">æœ¬æ–‡</h2>
                <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">è‡ªå‹•ã—ãŠã‚Šæ©Ÿèƒ½ON</span>
            </div>
            
            <!-- æœ¬æ–‡ã‚³ãƒ³ãƒ†ãƒŠ -->
            <article id="text-body" class="font-serif text-lg md:text-xl leading-loose text-gray-800 tracking-wide text-justify">
                <!-- JSã§ç”Ÿæˆ -->
            </article>

            <!-- èª­äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
            <div class="mt-16 p-8 text-center bg-gray-50 rounded-xl">
                <p class="text-gray-500 mb-4">èª­äº†ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸ</p>
                <div class="flex justify-center gap-4">
                    <button onclick="switchView('overview')" class="px-6 py-2 border border-gray-300 rounded-full text-sm hover:bg-gray-100">æ§‹æˆã‚’ç¢ºèªã™ã‚‹</button>
                </div>
            </div>
        </section>
    </main>

    <!-- 
    ========================================================================
    è§£èª¬è¡¨ç¤ºç”¨ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‘ãƒãƒ« (Sticky Bottom)
    æœ¬æ–‡ä¸­ã®èªå¥ã‚¿ãƒƒãƒ—æ™‚ã«è¡¨ç¤º
    ========================================================================
    -->
    <div id="annotation-box" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] transform translate-y-full transition-transform duration-300 z-40 p-4 md:px-8">
        <div class="max-w-4xl mx-auto flex items-start justify-between gap-4">
            <div>
                <div class="flex items-baseline gap-3 mb-1">
                    <h3 id="anno-term" class="text-lg font-bold text-theme-accent"></h3>
                    <span id="anno-reading" class="text-xs text-gray-400"></span>
                </div>
                <p id="anno-desc" class="text-sm md:text-base text-gray-700 leading-relaxed"></p>
            </div>
            <button onclick="closeAnnotation()" class="text-gray-400 hover:text-gray-600 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- 
    ========================================================================
    ãƒ•ãƒƒã‚¿ãƒ¼
    ========================================================================
    -->
    <footer class="bg-gray-100 py-6 text-center text-xs text-gray-400 mt-auto">
        <p>&copy; Interactive Literature Reader</p>
    </footer>

    <!-- 
    ========================================================================
    JavaScript ãƒ­ã‚¸ãƒƒã‚¯
    ========================================================================
    -->
    <script>
        /**
         * 1. ä½œå“ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ¬æ–‡ã€è§£èª¬ã€æ³¨é‡ˆï¼‰ã‚’å…¥åŠ›ãƒ»ç·¨é›†ã™ã‚‹å ´æ‰€
         * ä»¥ä¸‹ã®å®šæ•° BOOK_DATA ã‚’ä¿®æ­£ã™ã‚‹ã“ã¨ã§ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…¨ä½“ã‚’å·®ã—æ›¿ãˆå¯èƒ½ã§ã™ã€‚
         */
        const BOOK_DATA = {
            title: "ç«‹ã£ã¦ãã‚‹æ˜¥",
            author: "å·ä¸Š å¼˜ç¾",
            
            // æœ¬æ–‡ãƒ‡ãƒ¼ã‚¿ï¼ˆæ®µè½ã”ã¨ã®é…åˆ—ï¼‰
            paragraphs: [
                "ã€Œã‚‚ã†æ˜¥ã§ã™ã‚ˆã€ã²ã‚ã¿ã¡ã‚ƒã‚“ã€‚ã€ã¨ç¥–æ¯ã«è¨€ã‚ã‚Œã€é©šã„ãŸã€‚",
                "æ˜­å’ŒåŠã°ã®æ±äº¬ã€äºŒæœˆåˆæ—¬ã€‚ä¸€æ˜¨æ—¥ã¯é›ªãŒé™ã£ãŸã€‚å‡ºã—ãŸã°ã‹ã‚Šã®åä¸€æœˆã”ã‚ã«ã¯é‡ã„ã¨æ€ã£ã¦ã„ãŸå¸ƒå›£ã®ãã®é‡ã•ãŒå¬‰ã—ãã€ã„ã¤ã¾ã§ã‚‚æœã¯å¸ƒå›£ã‹ã‚‰å‡ºã‚‰ã‚Œãªã‹ã£ãŸã€‚ã¤ã¾ã•ãã‚’ã€ã‚‚ã†æš–ã‹ããªã„ã‚†ãŸã‚“ã½ã‚’åŒ…ã‚€ãƒãƒ«ã®å¸ƒã«ã€ããšããšã¨ãã£ã¤ã‘ã¦ã„ãŸã€‚",
                "ã‚ˆã†ã‚„ãå¸ƒå›£ã‹ã‚‰å‡ºã¦ã€é•·è¢–ã®ã‚·ãƒ£ãƒ„ã‚’ç€ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¹ã‚’ç€ã¦ã€ã‚»ãƒ¼ã‚¿ãƒ¼ã‚’ç€ã¦ã‚‚ã€ã¡ã£ã¨ã‚‚æš–ã‹ããªã‚‰ãªã„ã€‚æœ¨é€ ã®å®¶ã¯éš™é–“ã ã‚‰ã‘ã§ã€ã“ã®ã”ã‚ã®æ°—å¯†æ€§ã®ã‚ã‚‹å®¶ã®ã‚ˆã†ã«ã€çª“ã«çµéœ²ã‚’è¦‹ã‚‹ã“ã¨ã‚‚ãªã„ã€‚å¤–ã¨ä¸­ã®æ¸©åº¦ãŒã•ã»ã©å¤‰ã‚ã‚‰ãªã„ã®ã§ã€çµéœ²ã—ãªã„ã®ã§ã‚ã‚‹ã€‚åãæ¯ãŒç™½ã„ã€‚é¡”ã‚’æ´—ã„ãªãŒã‚‰ã€å¤–å›½ã®ãŠå§«ã•ã¾ã¯ãã£ã¨æ¯æ—¥ãŠæ¹¯ã§æ´—é¡”ã—ã¦ã‚‹ã‚“ã ã‚ã†ãªã‚ã€ãªã©ã¨è€ƒãˆã‚‹ã€‚",
                "ç§ã¯ã€æ—¥æœ¬ã®å°å­¦ç”Ÿã§ã€ã‚¿ã‚¤ãƒ„ã®è†ã«ã¯ã¤ããŒå½“ãŸã£ã¦ã„ã¦ï¼ˆã²ã©ãè²§ã—ã„ã‹ã‚‰ã€ã¨ã„ã†ã®ã§ã¯ãªã„ã€ã‚ã®ã“ã‚ã¯ã‚¹ãƒˆãƒƒã‚­ãƒ³ã‚°ã ã£ã¦ã„ã¡ã„ã¡ä¼ç·šã‚’ã‹ãŒã£ã¦ã„ãŸã‚‚ã®ã ã£ãŸï¼‰ã€æŒ‡å…ˆã«ã¯ã—ã‚‚ã‚„ã‘ãŒã‚ã£ã¦ã€å®ç‰©ã¯ç®±æ ¹ã¿ã‚„ã’ã®åƒä»£ç´™è²¼ã‚Šã®å…¥ã‚Œå­ã®ç®±ã¨ã‚¿ãƒŸãƒ¼äººå½¢ï¼ˆç€ã›æ›¿ãˆç”¨ã®æœã¯é«˜ä¾¡ãªã®ã§ã€æ¯ãŒè¦‹ã‚ˆã†è¦‹ã¾ã­ã§äºŒç€ã»ã©ç¸«ã£ã¦ãã‚ŒãŸï¼‰ã€ã¨ã„ã†ã”ãæ™®é€šã®å­ã©ã‚‚ã ã£ãŸã€‚",
                "ã€Œä»Šæ—¥ã‹ã‚‰æ˜¥ã§ã™ã‚ˆã€‚ã€ã‚‚ã†ä¸€åº¦ã€ç¥–æ¯ãŒè¨€ã£ãŸã€‚",
                "ã€Œã§ã‚‚ã¾ã å†¬ãªã®ã«ã€‚ã€ç§ã¯å£ã‚’ã¨ãŒã‚‰ã—ã¦ç­”ãˆãŸã€‚éœœæŸ±ã¯ã¤ã‚“ã¤ã‚“ç«‹ã£ã¦ã„ãŸã—ã€ãã®æœã‚‚æ°´é“ç®¡ãŒå‡ã£ãŸã€‚ã‚ãŠã‚ãŠã¨ã—ã¦ã„ã‚‹ã®ã¯ã¤ã‚ã¶ãã®è‘‰ã¨ã‚¢ã‚ªã‚­ã°ã‹ã‚Šã§ã€æ¥“ã‚‚æ¬…ã‚‚æ¡œã‚‚æŸ¿ã‚‚ã™ã£ã‹ã‚Šè‘‰ã‚’è½ã¨ã—ã¦ã—ã‚“ã¨ã—ã¦ã„ãŸã€‚å¯’æš–è¨ˆã®èµ¤ã¯ä¸‹ã®æ–¹ã«ã‚ã ã‹ã¾ã‚Šã€ãœã‚“ãœã‚“ä¸ŠãŒã£ã¦ã“ãªã„ã€‚",
                "ã€Œã§ã‚‚ã€æš¦ã®ä¸Šã§ã¯ã€ã»ã‚‰ã€‚ç«‹æ˜¥ã§ã™ã‚ˆã€‚ã€",
                "ã€Œã‚Šã£ã—ã‚…ã‚“ã€‚ã€",
                "ã€Œæ˜¥ãŒç«‹ã¤ã€æ˜¥ã«ãªã‚‹ã£ã¦ã„ã†ã“ã¨ã§ã™ã‚ˆã€‚ã€",
                "ç¥–æ¯ã®éƒ¨å±‹ã«ã¯æ—¥ã‚ãã‚Šã®æš¦ãŒä¸‹ã’ã¦ã‚ã£ãŸã€‚æš¦ã«ã¯ã€äºŒæœˆå››æ—¥ã€æœ¨æ›œã€ç«‹æ˜¥ã€ã®å­—ãŒä¸¦ã‚“ã§ã„ãŸã€‚",
                "ã€Œæ˜¥ã£ã¦ã€ç«‹ã¤ã®ã€‚ã€",
                "ã€Œç«‹ã¡ã¾ã™ã‚ˆã€‚ã€ãã†è¨€ã£ã¦ã€ç¥–æ¯ã¯çœŸé¢ç›®ã«é ·ã„ãŸã€‚ä»¥æ¥ç§ã¯ã€æ˜¥ã¯ç«‹ã¤ã‚‚ã®ã ã¨æ€ã†ã‚ˆã†ã«ãªã£ãŸã®ã§ã‚ã‚‹ã€‚",
                "ç«‹ã¤æ˜¥ã¨ã¯ã€ã©ã‚“ãªã‚‚ã®ãªã®ã ã‚ã†ã€‚å­¦æ ¡ã¸ã®ã¿ã¡ã¿ã¡ã€è€ƒãˆãŸã€‚",
                "äººé–“ã®ã‹ãŸã¡ã‚’ã—ãŸã‚‚ã®ã§ã¯ã€ãªã‹ã‚ã†ã€‚ç©ºæ°—ã®ã‚ˆã†ãªã‚‚ã®ã‹ã€‚ã§ã‚‚ç©ºæ°—ã¯ç›®ã«è¦‹ãˆãªã„ã€‚ã€Œç«‹ã¤ã€ã¨æ„Ÿã˜ã‚‹ã‹ã‚‰ã«ã¯ã€ç›®ã«è¦‹ãˆãªãã¦ã¯ã€‚æœ¬ã®ä¸­ã«ã‚ã‚‹ç«œã‚„é¬¼ã‚„å¦–æ€ªã«ä¼¼ãŸã€ã“ã®ä¸–ã®ã‚‚ã®ã§ã¯ãªã„ç”Ÿãç‰©ã®ã‹ãŸã¡ã‚’ã—ãŸã‚‚ã®ã‹ã€‚ãã‚Œã‚‚é•ã†ã€æ˜¥ã¯ã‚‚ã£ã¨æŸ”ã‚‰ã‹ã§ã®ã»ã»ã‚“ã¨ã—ã¦ã„ã‚‹ã‹ã‚‰ã€ç«ã‚’åã„ãŸã‚Šé‡‘æ£’ã‚’ãµã‚‹ã£ãŸã‚Šã™ã‚‹ã‚‚ã®ãŸã¡ã®é¡ã„ã§ã¯ã‚ã‚‹ã¾ã„ã€‚æ˜¥ã¨ã¯ã€ã“ã¾ã‹ãªç”Ÿæ°—ã‚ã‚‹ã‚‚ã®ã«æº€ã¡ãŸã€ç››ã‚Šä¸ŠãŒã‚‹ã‚ˆã†ãªã‚‚ã®ã ã€‚ãã‚Œãªã‚‰ã°ã€‚",
                "æ­©ããªãŒã‚‰ã€æ™´ã‚ŒãŸå†·ãŸã„ç©ºæ°—ã®ä¸­ã«è¦‹ãˆã‚‹é ã„å¯Œå£«ã‚’çœºã‚ã¤ã¤ã€ç§ã¯ã€Œç«‹ã£ã¦ãã‚‹æ˜¥ã€ã®ã‹ãŸã¡ã‚’ã€æ±ºã‚ãŸã€‚",
                "ç«‹ã£ã¦ãã‚‹æ˜¥ã¨ã¯ã€ã•ã¾ã–ã¾ãªå°ã•ã„ç”Ÿãç‰©ã§ã¿ã£ã—ã‚ŠåŸ‹ã‚ã¤ãã•ã‚ŒãŸä¸€æšã®çµµã®ã‚ˆã†ãªã‚‚ã®ã«ã¡ãŒã„ãªã„ã€‚ãã®æ˜¥ãŒã€åœ°å¹³ç·šã®å‘ã“ã†ã«ã‚†ã£ãã‚Šä¸ŠãŒã£ã¦ãã‚‹ã€‚æœ€åˆã®ã“ã‚ã¯ç«¯ã£ã“ã ã‘ã—ã‹åœ°å¹³ç·šè¿‘ãã«è¦‹ãˆã¦ã„ãªã„ãŒã€å¤ªé™½ãŒã®ã¼ã‚‹ã‚ˆã†ã«ã€æ—¥ã€…æ¬¡ç¬¬ã«é«˜ãã®ã¼ã£ã¦ã‚†ãã€‚ãã—ã¦å››æœˆã¨ã‚‚ãªã‚Œã°ã€ã™ã£ã‹ã‚Šå…¨å¤©ã‚’è¦†ã†ã‚ˆã†ã«ãªã‚‹ã®ã§ã‚ã‚‹ã€‚",
                "ã“ã‚Œã ã‘ã®ã“ã¨ã‚’æ±ºã‚ã€ã‚ˆã†ã‚„ãç§ã¯æº€è¶³ã—ãŸã€‚ã‚ˆã—ã‚ˆã—ã€‚è¬ã¯è§£ã‘ãŸã€‚ãªã‚‹ã»ã©æ˜¥ã¯ç«‹ã¤ã‚‚ã®ã§ã‚ã‚ã†ã€‚ã¾ã ã‚ã‚“ã¾ã‚Šè¦‹ãˆãªã„ã‘ã‚Œã©ã€ãŸã—ã‹ã«ã€ä»Šæ—¥ã€ãšã£ã¨å‘ã“ã†ã®ã‚ã®å±±ã®ã‚ãŸã‚Šã«ã€æ˜¥ãŒç«‹ã£ãŸã€‚ã†ã‚“ã†ã‚“ã€‚",
                "å‹æ‰‹ã«è§£ã‹ã‚Œã¦ã—ã¾ã£ãŸã€Œæ˜¥ãŒç«‹ã¤ã€è¬ã¯ã€ä»Šã«ã„ãŸã‚‹ã¾ã§ã€ã˜ã¤ã¯ç§ã®ä¸­ã«å±…ã¤ã¥ã‘ã¦ã„ã‚‹ã€‚ç¾åœ¨ã‚‚ã€ç«‹æ˜¥ã¨ã„ã†è¨€è‘‰ã‚’èãã¨ã€åå°„çš„ã«ã€æ°´å¹³ç·šã‹ã‚‰ã‚†ã£ãã‚Šã¨ç«‹ã¡ä¸ŠãŒã£ã¦ãã‚‹é„ã®ã‚ˆã†ãªçµµã‚’æ€ã„æµ®ã‹ã¹ã‚‹ã®ã§ã‚ã‚‹ã€‚",
                "ã¾ã ã¾ã å¯’ã„ã€ã—ã‹ã—ã˜ãã«ã€æ˜¥ã§ã‚ã‚‹ã€‚"
            ],

            // 1. å¤§ã¾ã‹ãªå†…å®¹ï¼ˆStructure/Overviewï¼‰
            structure: [
                {
                    title: "å†¬ã®æœã¨ç¥–æ¯ã®è¨€è‘‰",
                    summary: "å¯’ã„2æœˆåˆæ—¬ã®æœã€ç¥–æ¯ã«ã€Œã‚‚ã†æ˜¥ã ã€ã¨å‘Šã’ã‚‰ã‚Œã€ä¸»äººå…¬ã¯é©šãã¨ã¨ã‚‚ã«é•å’Œæ„Ÿã‚’è¦šãˆã‚‹ã€‚",
                    tags: ["æ—¥å¸¸", "å†¬ã®å¯’ã•", "å¯¾è©±"],
                    details: "æ™‚ä»£èƒŒæ™¯ã¯æ˜­å’ŒåŠã°ã€‚æœ¨é€ å®¶å±‹ã®å¯’ã•ã‚„æ¹¯ãŸã‚“ã½ã€ã—ã‚‚ã‚„ã‘ã¨ã„ã£ãŸæå†™ã‹ã‚‰ã€å½“æ™‚ã®ç”Ÿæ´»æ„ŸãŒè‰²æ¿ƒãæã‹ã‚Œã¦ã„ã‚‹ã€‚"
                },
                {
                    title: "ç«‹æ˜¥ã®è¬",
                    summary: "ã€Œæ˜¥ãŒç«‹ã¤ã€ã¨ã„ã†è¨€è‘‰ã®æ„å‘³ã‚’ã€å­ä¾›ãªãŒã‚‰ã®æ„Ÿæ€§ã§çœŸå‰£ã«è€ƒå¯Ÿã—å§‹ã‚ã‚‹ã€‚",
                    tags: ["ç«‹æ˜¥", "è¨€è‘‰éŠã³", "æƒ³åƒ"],
                    details: "ç¥–æ¯ã®ã€Œæš¦ã®ä¸Šã§ã¯ã€ã¨ã„ã†è¨€è‘‰ã«å¯¾ã—ã€ä¸»äººå…¬ã¯ã€Œç«‹ã¤ã€ã¨ã„ã†å‹•è©ã«ã“ã ã‚ã‚Šã€ãã®è¦–è¦šçš„ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ¨¡ç´¢ã™ã‚‹ã€‚"
                },
                {
                    title: "æ˜¥ã®æ­£ä½“ã®ç™ºè¦‹",
                    summary: "ç™»æ ¡ä¸­ã€æ˜¥ã¨ã¯ã€Œå°ã•ãªç”Ÿãç‰©ã§åŸ‹ã‚å°½ãã•ã‚ŒãŸçµµã€ãŒåœ°å¹³ç·šã‹ã‚‰ä¸ŠãŒã£ã¦ãã‚‹ã‚‚ã®ã ã¨çµè«–ã¥ã‘ã‚‹ã€‚",
                    tags: ["è§£æ±º", "å¿ƒè±¡é¢¨æ™¯", "ç´å¾—"],
                    details: "ã€Œå¤ªé™½ãŒã®ã¼ã‚‹ã‚ˆã†ã«ã€æ˜¥ãŒç«‹ã¡ä¸ŠãŒã£ã¦ãã‚‹ã¨ã„ã†ã€ä¸»äººå…¬ç‹¬è‡ªã®è©©çš„ã§ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãªä¸–ç•Œè¦³ãŒå®Œæˆã™ã‚‹ã€‚"
                },
                {
                    title: "ç¾åœ¨ã®è¦–ç‚¹",
                    summary: "å¤§äººã«ãªã£ãŸç¾åœ¨ã‚‚ã€ãã®æ™‚ã«æŠ±ã„ãŸã€Œæ˜¥ãŒç«‹ã¤ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒã¡ç¶šã‘ã¦ã„ã‚‹ã€‚",
                    tags: ["å›æƒ³", "ç¶™ç¶š", "çµã³"],
                    details: "å­ä¾›æ™‚ä»£ã®ç©ºæƒ³ãŒã€å¤§äººã«ãªã£ã¦ã‹ã‚‰ã®æ„Ÿè¦šã«ã‚‚å½±éŸ¿ã‚’ä¸ãˆç¶šã‘ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã€ç‰©èªã‚’ç· ã‚ããã‚‹ã€‚"
                }
            ],

            // 2. ç™»å ´äººç‰©ãƒ»è¦ç´ åˆ†æï¼ˆCharactersï¼‰
            characters: [
                {
                    name: "ç§ï¼ˆã²ã‚ã¿ã¡ã‚ƒã‚“ï¼‰",
                    role: "ä¸»äººå…¬ãƒ»èªã‚Šæ‰‹",
                    desc: "æ˜­å’ŒåŠã°ã®æ™®é€šã®å°å­¦ç”Ÿã€‚æ„Ÿå—æ€§ãŒè±Šã‹ã§ã€å¤§äººã®è¨€è‘‰ã‚’æ–‡å­—é€šã‚Šå—ã‘å–ã‚Šã€ç‹¬è‡ªã®è«–ç†ã§ä¸–ç•Œã‚’è§£é‡ˆã—ã‚ˆã†ã¨ã™ã‚‹ã€‚",
                    quote: "ã€Œã§ã‚‚ã¾ã å†¬ãªã®ã«ã€‚ã€",
                    evolution: "è¨€è‘‰ã¸ã®ç–‘å•ã‹ã‚‰å‡ºç™ºã—ã€ç‹¬è‡ªã®ã€Œæ˜¥ã€ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã§ç´å¾—ï¼ˆæˆé•·ï¼‰ã‚’å¾—ã‚‹ã€‚"
                },
                {
                    name: "ç¥–æ¯",
                    role: "å°ãæ‰‹",
                    desc: "ä¸»äººå…¬ã«ã€Œæš¦ã®ä¸Šã®äº‹å®Ÿã€ã‚’ä¼ãˆã‚‹å­˜åœ¨ã€‚çœŸé¢ç›®ãªæ€§æ ¼ã§ã€å­ä¾›ã®ç–‘å•ã«ã‚‚çœŸå‰£ã«å‘ãåˆã†ã€‚",
                    quote: "ã€Œæ˜¥ãŒç«‹ã¤ã€æ˜¥ã«ãªã‚‹ã£ã¦ã„ã†ã“ã¨ã§ã™ã‚ˆã€‚ã€",
                    evolution: "æ˜”ãªãŒã‚‰ã®å­£ç¯€æ„Ÿã‚’å¤§åˆ‡ã«ã—ã¦ãŠã‚Šã€å¯’ã•ã®ä¸­ã§ã‚‚æ˜¥ã®åˆ°æ¥ã‚’ç¢ºä¿¡ã—ã¦ã„ã‚‹ã€‚"
                }
            ],

            // 3. é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»è±¡å¾´ï¼ˆKeywordsï¼‰
            // æ³¨: ã“ã“ã® `term` ãŒæœ¬æ–‡ä¸­ã§è‡ªå‹•çš„ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã¾ã™
            keywords: [
                {
                    term: "ç«‹æ˜¥",
                    reading: "ã‚Šã£ã—ã‚…ã‚“",
                    meaning: "äºŒåå››ç¯€æ°—ã®ä¸€ã¤ã€‚æš¦ã®ä¸Šã§æ˜¥ãŒå§‹ã¾ã‚‹ã¨ã•ã‚Œã‚‹æ—¥ï¼ˆ2æœˆ4æ—¥é ƒï¼‰ã€‚",
                    context: "æœ¬ä½œã®æ ¸å¿ƒçš„ãªãƒ†ãƒ¼ãƒã€‚å¯’ã•ãŒå³ã—ã„æ™‚æœŸã«ã‚ã‚‹ãŸã‚ã€ä½“æ„Ÿã¨ã®ã‚ºãƒ¬ãŒä¸»äººå…¬ã®æ€ç´¢ã®ãã£ã‹ã‘ã¨ãªã‚‹ã€‚"
                },
                {
                    term: "éœœæŸ±",
                    reading: "ã—ã‚‚ã°ã—ã‚‰",
                    meaning: "åœ°ä¸­ã®æ°´åˆ†ãŒå‡ã£ã¦åœ°è¡¨ã«æŸ±çŠ¶ã«ç¾ã‚ŒãŸæ°·ã€‚",
                    context: "ç¾å®Ÿã®ã€Œå†¬ã®å¯’ã•ã€ã‚’è±¡å¾´ã™ã‚‹å…·ä½“çš„è¦ç´ ã¨ã—ã¦æã‹ã‚Œã€ã€Œç«‹ã¤ã€ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å¯¾æ¯”ã«ã‚‚ãªã£ã¦ã„ã‚‹ã€‚"
                },
                {
                    term: "å¯’æš–è¨ˆ",
                    reading: "ã‹ã‚“ã ã‚“ã‘ã„",
                    meaning: "æ¸©åº¦è¨ˆã®ã“ã¨ã€‚",
                    context: "ã€Œèµ¤ã¯ä¸‹ã®æ–¹ã«ã‚ã ã‹ã¾ã‚Šã€ã¨ã„ã†è¡¨ç¾ã§ã€æ°—æ¸©ã®ä½ã•ã¨ã€æ˜¥ã®æ°—é…ã®ãªã•ã‚’è¦–è¦šçš„ã«å¼·èª¿ã—ã¦ã„ã‚‹ã€‚"
                },
                {
                    term: "æš¦",
                    reading: "ã“ã‚ˆã¿",
                    meaning: "ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€‚æ™‚ã®æµã‚Œã‚„å­£ç¯€ã‚’è¨˜ã—ãŸã‚‚ã®ã€‚",
                    context: "è‡ªç„¶ã®æ„Ÿè¦šã¨ã¯ç•°ãªã‚‹ã€Œç¤¾ä¼šçš„ãªæ™‚é–“ã€ã‚„ã€Œæ±ºã¾ã‚Šã€ã®è±¡å¾´ã€‚ç¥–æ¯ã®ä¸–ç•Œï¼ˆå¤§äººã®ç†å±ˆï¼‰ã‚’ä»£è¡¨ã™ã‚‹ã‚‚ã®ã€‚"
                },
                {
                    term: "ã‚†ãŸã‚“ã½",
                    reading: "ã‚†ãŸã‚“ã½",
                    meaning: "ãŠæ¹¯ã‚’å…¥ã‚Œã¦æš–ã‚’å–ã‚‹é“å…·ã€‚",
                    context: "æ˜­å’Œã®å†¬ã®ç”Ÿæ´»æ„Ÿã‚’å‡ºã™é‡è¦ãªå°é“å…·ã€‚ã€Œã‚‚ã†æš–ã‹ããªã„ã€ã“ã¨ã§æœã®æ™‚é–“çµŒéã¨å¯’ã•ã‚’æ¼”å‡ºã—ã¦ã„ã‚‹ã€‚"
                },
                {
                    term: "ãƒãƒ«",
                    reading: "ã­ã‚‹",
                    meaning: "ãƒ•ãƒ©ãƒ³ãƒãƒ«ã®ç•¥ã€‚æŸ”ã‚‰ã‹ãèµ·æ¯›ã—ãŸç¶¿ç¹”ç‰©ã€‚",
                    context: "è‚Œè§¦ã‚Šã®æå†™ã‚’é€šã˜ã¦ã€å¸ƒå›£ã®ä¸­ã®å¿ƒåœ°ã‚ˆã•ã¨å¤–æ°—ã®å¯’ã•ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’æã„ã¦ã„ã‚‹ã€‚"
                },
                {
                    term: "æ°—å¯†æ€§",
                    reading: "ãã¿ã¤ã›ã„",
                    meaning: "ç©ºæ°—ã®å‡ºå…¥ã‚Šã‚’é˜²ãæ€§èƒ½ã€‚",
                    context: "ç¾ä»£ã®å®¶ã¨ã®æ¯”è¼ƒã¨ã—ã¦ç”¨ã„ã‚‰ã‚Œã€å½“æ™‚ã®æœ¨é€ å®¶å±‹ãŒã„ã‹ã«å¯’ã‹ã£ãŸã‹ï¼ˆå¤–ã¨ä¸­ãŒå¤‰ã‚ã‚‰ãªã„ï¼‰ã‚’èª¬æ˜ã—ã¦ã„ã‚‹ã€‚"
                },
                {
                    term: "ã¤ã‚ã¶ã",
                    reading: "ã¤ã‚ã¶ã",
                    meaning: "ã‚­ã‚¯ç§‘ã®å¸¸ç·‘å¤šå¹´è‰ã€‚å†¬ã§ã‚‚ç·‘ã®è‘‰ã‚’ä¿ã¤ã€‚",
                    context: "å†¬æ¯ã‚Œã®ä¸­ã§æ•°å°‘ãªã„ã€Œç”Ÿã€ã‚’æ„Ÿã˜ã•ã›ã‚‹æ¤ç‰©ã¨ã—ã¦æã‹ã‚Œã¦ã„ã‚‹ã€‚"
                },
                {
                    term: "é¬¼",
                    reading: "ãŠã«",
                    meaning: "æ—¥æœ¬ã®ä¼æ‰¿ã«ãŠã‘ã‚‹æ¶ç©ºã®æ€ªç‰©ã€‚",
                    context: "ä¸»äººå…¬ãŒã€Œæ˜¥ã€ã‚’ç”Ÿãç‰©ã¨ã—ã¦æƒ³åƒã™ã‚‹éš›ã€å¦å®šçš„ãªä¾‹ï¼ˆæ€–ã„ã‚‚ã®ï¼‰ã¨ã—ã¦æŒ™ã’ã‚‰ã‚Œã¦ã„ã‚‹ã€‚"
                },
                {
                    term: "å¯Œå£«",
                    reading: "ãµã˜",
                    meaning: "æ—¥æœ¬ä¸€é«˜ã„å±±ã€‚",
                    context: "å†¬ã®æ¾„ã‚“ã ç©ºæ°—æ„Ÿã‚’å¼·èª¿ã™ã‚‹èƒŒæ™¯ã€‚ã€Œé ã„å¯Œå£«ã€ã‚’è¦‹ã‚‹è¦–ç‚¹ãŒã€æ€è€ƒã®åºƒãŒã‚Šã‚’æš—ç¤ºã—ã¦ã„ã‚‹ã€‚"
                },
                {
                    term: "çµéœ²",
                    reading: "ã‘ã¤ã‚",
                    meaning: "æš–ã‹ã„ç©ºæ°—ãŒå†·ãŸã„ç‰©ã«è§¦ã‚Œã¦ã€æ°´åˆ†ãŒæ°´æ»´ã¨ãªã‚‹ç¾è±¡ã€‚",
                    context: "å½“æ™‚ã®å®¶å±‹ã¯éš™é–“ãŒå¤šãã€å¤–æ°—ã¨å®¤æ¸©ã®å·®ãŒå°ã•ã‹ã£ãŸãŸã‚ç™ºç”Ÿã—ãªã‹ã£ãŸã€‚å®¶ã®å¯’ã•ã‚’é€†èª¬çš„ã«å¼·èª¿ã—ã¦ã„ã‚‹ã€‚"
                },
                {
                    term: "æ¥“",
                    reading: "ã‹ãˆã§",
                    meaning: "ã‚«ã‚¨ãƒ‡ç§‘ã®è½è‘‰é«˜æœ¨ã€‚ç§‹ã«ç´…è‘‰ã—ã€å†¬ã«ã¯è‘‰ã‚’è½ã¨ã™ã€‚",
                    context: "å†¬ã®æ™¯è‰²ã¨ã—ã¦ç™»å ´ã€‚ã€Œã™ã£ã‹ã‚Šè‘‰ã‚’è½ã¨ã—ã¦ã€ã„ã‚‹ã“ã¨ã§ã€æ˜¥ã®ç”Ÿå‘½åŠ›ãŒã¾ã ç›®ã«è¦‹ãˆãªã„é™ã‘ã•ã‚’è¡¨ã—ã¦ã„ã‚‹ã€‚"
                },
                {
                    term: "æ¬…",
                    reading: "ã‘ã‚„ã",
                    meaning: "ãƒ‹ãƒ¬ç§‘ã®è½è‘‰é«˜æœ¨ã€‚è¡—è·¯æ¨¹ã‚„å…¬åœ’æ¨¹ã¨ã—ã¦ä¸€èˆ¬çš„ã€‚",
                    context: "æ¥“ã¨åŒæ§˜ã€å†¬æ¯ã‚Œã®é¢¨æ™¯ã®ä¸€éƒ¨ã€‚å¯’ã€…ã¨ã—ãŸæ™¯è‰²ã®æå†™ã«ã‚ˆã‚Šã€ä¸»äººå…¬ãŒæ„Ÿã˜ã‚‹ã€Œã¾ã å†¬ã€ã¨ã„ã†æ„Ÿè¦šã‚’è£œå¼·ã™ã‚‹ã€‚"
                },
                {
                    term: "é„",
                    reading: "ã‚‚ã‚„",
                    meaning: "å¤§æ°—ä¸­ã«æµ®ã‹ã¶å¾®å°ãªæ°´æ»´ã«ã‚ˆã‚Šã€é ããŒã‹ã™ã‚“ã§è¦‹ãˆã‚‹ç¾è±¡ã€‚",
                    context: "ä¸»äººå…¬ãŒå¿ƒã®ä¸­ã§æã„ãŸã€Œç«‹ã£ã¦ãã‚‹æ˜¥ã€ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚å½¢ãŒå®šã¾ã‚‰ãšã€ã‚†ã£ãã‚Šã¨ç«‹ã¡ä¸Šã‚‹æ°—é…ã®ã‚ˆã†ãªã‚‚ã®ã‚’è¡¨ç¾ã—ã¦ã„ã‚‹ã€‚"
                }
            ]
        };

        // DOMè¦ç´ ã®å–å¾—
        const headerTitle = document.getElementById('header-title');
        const headerAuthor = document.getElementById('header-author');
        const textBodyEl = document.getElementById('text-body');
        const annoBox = document.getElementById('annotation-box');
        
        // çŠ¶æ…‹ç®¡ç†
        let currentView = 'read'; // åˆæœŸãƒ“ãƒ¥ãƒ¼ã¯ã€Œæœ¬æ–‡ã€ã«è¨­å®šï¼ˆè¦ä»¶ã«åˆã‚ã›ã¦å¤‰æ›´å¯ï¼‰
        
        /**
         * åˆæœŸåŒ–å‡¦ç†
         */
        function init() {
            // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±è¨­å®š
            headerTitle.textContent = BOOK_DATA.title;
            headerAuthor.textContent = `ä½œï¼š${BOOK_DATA.author}`;

            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            renderOverview();
            renderCharacters();
            renderKeywords();
            renderTextBody();

            // èª­æ›¸ä½ç½®ã®å¾©å…ƒï¼ˆåˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ï¼‰
            restoreScrollPosition();

            // åˆæœŸãƒ“ãƒ¥ãƒ¼ã®è¡¨ç¤º
            switchView('read', true); // åˆå›ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—
        }

        /**
         * ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
         * @param {string} viewId - åˆ‡ã‚Šæ›¿ãˆå…ˆã®ãƒ“ãƒ¥ãƒ¼ID ('overview', 'characters', etc.)
         * @param {boolean} isInitial - åˆæœŸãƒ­ãƒ¼ãƒ‰ã‹ã©ã†ã‹
         */
        function switchView(viewId, isInitial = false) {
            // ç¾åœ¨ãŒã€ŒReadã€ãƒ“ãƒ¥ãƒ¼ã ã£ãŸå ´åˆã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜ã™ã‚‹
            if (currentView === 'read' && viewId !== 'read') {
                saveScrollPosition();
            }

            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isActive = btn.id === `nav-${viewId}`;
                btn.className = isActive 
                    ? 'nav-btn px-4 py-2 text-sm font-bold rounded-full transition-colors whitespace-nowrap bg-theme-accent text-white shadow-md'
                    : 'nav-btn px-4 py-2 text-sm font-bold rounded-full transition-colors whitespace-nowrap bg-gray-100 text-gray-600 hover:bg-theme-accent hover:text-white';
            });

            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆï¼ˆç‰©ç†é·ç§»ãªã—ï¼‰
            document.querySelectorAll('.view-section').forEach(section => {
                if (section.id === `view-${viewId}`) {
                    section.classList.remove('hidden');
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã«å°‘ã—é…ã‚‰ã›ã¦opacityãªã©ã‚’ã„ã˜ã‚ŠãŸã„å ´åˆã¯ã“ã“ã«è¨˜è¿°
                } else {
                    section.classList.add('hidden');
                }
            });

            // è§£èª¬ãƒœãƒƒã‚¯ã‚¹ãŒé–‹ã„ã¦ã„ãŸã‚‰é–‰ã˜ã‚‹
            closeAnnotation();

            currentView = viewId;

            // ã€ŒReadã€ãƒ“ãƒ¥ãƒ¼ã«æˆ»ã£ã¦ããŸå ´åˆã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
            if (viewId === 'read' && !isInitial) {
                restoreScrollPosition();
            } else if (viewId !== 'read') {
                // ä»–ã®ãƒ“ãƒ¥ãƒ¼ã¯ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                window.scrollTo(0, 0);
            }
        }

        /**
         * 2. ã€Œèª­æ›¸ä½ç½®ã®è¨˜æ†¶ã€ã‚’è¡Œã£ã¦ã„ã‚‹ãƒ­ã‚¸ãƒƒã‚¯éƒ¨åˆ†
         * LocalStorageã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’æ°¸ç¶šåŒ–ã—ã¾ã™ã€‚
         */
        const STORAGE_KEY = `scroll_pos_${BOOK_DATA.title}`;

        function saveScrollPosition() {
            const scrollY = window.scrollY;
            localStorage.setItem(STORAGE_KEY, scrollY);
            console.log('Saved Position:', scrollY);
        }

        function restoreScrollPosition() {
            const savedY = localStorage.getItem(STORAGE_KEY);
            if (savedY) {
                // DOMæç”»ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è€ƒæ…®ã—ã¦ã‚ãšã‹ã«é…å»¶
                setTimeout(() => {
                    window.scrollTo({
                        top: parseInt(savedY, 10),
                        behavior: 'auto' // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®ãŸã‚å³åº§ã«ç§»å‹•
                    });
                }, 10);
            }
        }

        // ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹/ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ç›´å‰ã«ã‚‚ä¿å­˜
        window.addEventListener('beforeunload', () => {
            if (currentView === 'read') {
                saveScrollPosition();
            }
        });


        /**
         * ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°: å¤§ã¾ã‹ãªå†…å®¹
         */
        function renderOverview() {
            const container = document.getElementById('overview-container');
            container.innerHTML = BOOK_DATA.structure.map((item, index) => `
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow cursor-pointer" onclick="toggleAccordion('over-${index}')">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-lg text-gray-800"><span class="text-theme-accent mr-2">Scene ${index + 1}</span>${item.title}</h3>
                        <span class="text-gray-400 text-xl transform transition-transform" id="icon-over-${index}">+</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-3">${item.summary}</p>
                    <div class="flex flex-wrap gap-2 mb-2">
                        ${item.tags.map(tag => `<span class="px-2 py-1 bg-gray-100 text-gray-500 text-xs rounded">${tag}</span>`).join('')}
                    </div>
                    
                    <!-- ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³è©³ç´° -->
                    <div id="over-${index}" class="accordion-content">
                        <div class="pt-3 mt-3 border-t border-gray-100 text-sm text-gray-700 leading-relaxed bg-gray-50 p-3 rounded">
                            <strong>è©³ç´°è§£èª¬:</strong><br>
                            ${item.details}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        /**
         * ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°: ç™»å ´äººç‰©
         */
        function renderCharacters() {
            const container = document.getElementById('characters-container');
            container.innerHTML = BOOK_DATA.characters.map((char, index) => `
                <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-gray-300 hover:border-theme-accent transition-colors cursor-pointer" onclick="toggleAccordion('char-${index}')">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-lg">${char.name}</h3>
                            <p class="text-xs text-gray-500">${char.role}</p>
                        </div>
                        <span class="text-gray-400 transform transition-transform" id="icon-char-${index}">â–¼</span>
                    </div>
                    
                    <div id="char-${index}" class="accordion-content">
                        <div class="mt-4 space-y-3 text-sm">
                            <p class="text-gray-700">${char.desc}</p>
                            <div class="bg-gray-50 p-3 rounded italic text-gray-600 border-l-2 border-gray-400">
                                "${char.quote}"
                            </div>
                            <div>
                                <strong class="text-theme-accent">å¤‰åŒ–ãƒ»ç‰¹å¾´:</strong>
                                <p class="text-gray-600">${char.evolution}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        /**
         * ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
         */
        function renderKeywords() {
            const container = document.getElementById('keywords-container');
            container.innerHTML = BOOK_DATA.keywords.map((kw, index) => `
                <div class="bg-white px-4 py-3 rounded border border-gray-200 hover:bg-gray-50 cursor-pointer transition-colors" onclick="toggleAccordion('kw-${index}')">
                    <div class="flex items-baseline gap-3">
                        <span class="font-bold text-theme-accent text-lg">${kw.term}</span>
                        <span class="text-xs text-gray-400">${kw.reading}</span>
                    </div>
                    
                    <div id="kw-${index}" class="accordion-content">
                        <div class="mt-2 pt-2 border-t border-dashed border-gray-200 text-sm">
                            <p class="mb-2"><strong>æ„å‘³:</strong> ${kw.meaning}</p>
                            <p class="text-gray-600 bg-gray-50 p-2 rounded"><strong>æ–‡è„ˆ:</strong> ${kw.context}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        /**
         * ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°: æœ¬æ–‡ï¼ˆè‡ªå‹•ãƒã‚¤ãƒ©ã‚¤ãƒˆä»˜ãï¼‰
         */
        function renderTextBody() {
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é•·ã„é †ã«ã‚½ãƒ¼ãƒˆã™ã‚‹ãŒã€å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒã—ã¦ãŠã
            // ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã«æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            const sortedKeywords = BOOK_DATA.keywords
                .map((kw, index) => ({ term: kw.term, originalIndex: index }))
                .sort((a, b) => b.term.length - a.term.length);

            const htmlContent = BOOK_DATA.paragraphs.map(paragraph => {
                let processedText = paragraph;
                
                // å„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¿ã‚°ã§å›²ã‚€
                sortedKeywords.forEach((kw) => {
                    // å˜ç´”ãªç½®æ›ã ã¨æ—¢ã«ç½®æ›ã•ã‚ŒãŸHTMLã‚¿ã‚°ã®ä¸­èº«ã¾ã§å£Šã™å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€
                    // æœ¬ç•ªç’°å¢ƒã§ã¯ã‚ˆã‚Šå …ç‰¢ãªãƒ‘ãƒ¼ã‚µãƒ¼æ¨å¥¨ã ãŒã€ã“ã“ã§ã¯ç°¡æ˜“çš„ã«å®Ÿè£…
                    const regex = new RegExp(`(${kw.term})`, 'g');
                    // showAnnotationã«ã¯å…ƒã®é…åˆ—(BOOK_DATA.keywords)ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹(originalIndex)ã‚’æ¸¡ã™
                    processedText = processedText.replace(regex, `<span class="text-highlight" onclick="showAnnotation(${kw.originalIndex}, event)">$1</span>`);
                });

                return `<p class="mb-6">${processedText}</p>`;
            }).join('');

            textBodyEl.innerHTML = htmlContent;
        }

        /**
         * UIãƒ­ã‚¸ãƒƒã‚¯: ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
         */
        function toggleAccordion(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            const isOpen = content.style.maxHeight;

            // ä»–ã®ã™ã¹ã¦ã‚’é–‰ã˜ã‚‹å‹•ä½œã‚’å…¥ã‚Œã‚‹å ´åˆã¯ã“ã“ã«è¨˜è¿°ï¼ˆä»Šå›ã¯è¤‡æ•°å±•é–‹å¯ã¨ã™ã‚‹ï¼‰

            if (isOpen) {
                content.style.maxHeight = null;
                content.classList.remove('open');
                if(icon) icon.style.transform = 'rotate(0deg)';
                if(icon && icon.innerText === '-') icon.innerText = '+';
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                content.classList.add('open');
                if(icon) icon.style.transform = 'rotate(180deg)';
                if(icon && icon.innerText === '+') icon.innerText = '-';
            }
        }

        /**
         * UIãƒ­ã‚¸ãƒƒã‚¯: æ³¨é‡ˆè¡¨ç¤º (Footer Overlay)
         */
        function showAnnotation(keywordIndex, event) {
            event.stopPropagation(); // è¦ªè¦ç´ ã¸ã®ãƒãƒ–ãƒªãƒ³ã‚°é˜²æ­¢
            
            // å…¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹è§£é™¤
            document.querySelectorAll('.text-highlight').forEach(el => el.classList.remove('active'));
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            event.target.classList.add('active');

            const data = BOOK_DATA.keywords[keywordIndex];
            
            // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
            document.getElementById('anno-term').textContent = data.term;
            document.getElementById('anno-reading').textContent = data.reading;
            document.getElementById('anno-desc').innerHTML = `
                <span class="font-bold block mb-1">æ„å‘³: ${data.meaning}</span>
                <span class="block text-gray-500 text-xs">æ–‡è„ˆãƒ»è§£èª¬: ${data.context}</span>
            `;

            // è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            annoBox.classList.remove('translate-y-full');
        }

        function closeAnnotation() {
            annoBox.classList.add('translate-y-full');
            document.querySelectorAll('.text-highlight').forEach(el => el.classList.remove('active'));
        }

        // æœ¬æ–‡ä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰æ³¨é‡ˆã‚’é–‰ã˜ã‚‹
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#annotation-box') && !e.target.classList.contains('text-highlight')) {
                closeAnnotation();
            }
        });

        // ã‚¢ãƒ—ãƒªèµ·å‹•
        init();

    </script>
</body>
</html>
